<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Pháo hoa hình trái tim</title>
  <style>
    /* Căn giữa body, cố định size container */
    body, html {
      margin: 0;
      height: 100%;
      background-color: black;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: 'Segoe UI', sans-serif;
      overflow: hidden;
    }

    /* Canvas cố định kích thước */
    #canvas {
      display: none;
      width: 360px;
      height: 640px;
      background: black;
      border-radius: 15px;
      box-shadow: 0 0 20px #ff2f9f;
    }

    /* Màn hình nhập mật mã cố định size */
    #passwordScreen {
      position: fixed;
      width: 360px;
      height: 640px;
      background: black;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      border-radius: 15px;
      box-shadow: 0 0 20px #ff2f9f;
      z-index: 20;
      user-select: none;
    }

    #keypad {
      display: grid;
      grid-template-columns: repeat(3, 80px);
      grid-gap: 15px;
      margin-top: 20px;
    }

    .key {
      width: 80px;
      height: 80px;
      background: #333;
      color: white;
      font-size: 24px;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }

    .key:active {
      background: #555;
    }

    #dots {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .dot {
      width: 16px;
      height: 16px;
      background: #777;
      border-radius: 50%;
    }

    .dot.filled {
      background: white;
    }

    #errorMsg {
      color: red;
      margin-top: 10px;
      height: 20px;
    }

    /* Controls cố định vị trí và kích thước */
    #controls {
      display: none;
      position: absolute;
      bottom: 20px;
      width: 360px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      color: white;
      background-color: rgba(0, 0, 0, 0.5);
      padding: 12px 30px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      box-sizing: border-box;
    }

    .control-row {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      gap: 10px;
    }
    label {
      flex-shrink: 0;
      width: 60px;
    }
    input[type="range"], input[type="color"] {
      flex-grow: 1;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="passwordScreen">
    <h2>Nhập mật mã</h2>
    <div id="dots">
      <div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
      <div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
    </div>
    <div id="keypad">
      <div class="key">1</div><div class="key">2</div><div class="key">3</div>
      <div class="key">4</div><div class="key">5</div><div class="key">6</div>
      <div class="key">7</div><div class="key">8</div><div class="key">9</div>
      <div class="key">←</div><div class="key">0</div><div class="key">OK</div>
    </div>
    <p id="errorMsg"></p>
  </div>

  <canvas id="canvas"></canvas>

  <div id="controls">
    <div class="control-row">
      <label for="speedSlider">Tốc độ</label>
      <input type="range" id="speedSlider" min="10" max="200" value="100" />
    </div>
    <div class="control-row">
      <label for="colorSlider">Màu</label>
      <input type="color" id="colorSlider" value="#ff2f9f" />
    </div>
  </div>

  <script>
    const correctPassword = "08112006";
    let entered = "";

    const keys = document.querySelectorAll(".key");
    const dots = document.querySelectorAll(".dot");
    const errorMsg = document.getElementById("errorMsg");

    keys.forEach(key => {
      key.addEventListener("click", () => {
        const val = key.textContent;

        if (val === "←") {
          entered = entered.slice(0, -1);
        } else if (val === "OK") {
          if (entered === correctPassword) {
            document.getElementById("passwordScreen").style.display = "none";
            document.getElementById("canvas").style.display = "block";
            document.getElementById("controls").style.display = "block";
            startEffect();
          } else {
            errorMsg.textContent = "Sai mật mã. Thử lại!";
            entered = "";
          }
        } else {
          if (entered.length < 8) {
            entered += val;
          }
        }

        updateDots();
      });
    });

    function updateDots() {
      dots.forEach((dot, i) => {
        dot.classList.toggle("filled", i < entered.length);
      });
    }

    function startEffect() {
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      const colorSlider = document.getElementById('colorSlider');
      const speedSlider = document.getElementById('speedSlider');

      function resizeCanvas() {
        // Cố định kích thước canvas 360x640
        canvas.width = 360;
        canvas.height = 640;
      }
      resizeCanvas();

      const fontSize = 16;
      const densityFactor = 2;
      let columns = Math.floor(canvas.width / fontSize / densityFactor);
      let drops = Array(columns).fill(1);

      const fireworks = [];

      class Particle {
        constructor(x, y, color, char) {
          this.x = x;
          this.y = y;
          this.char = char;
          this.color = color;
          this.alpha = 1;
          this.speed = Math.random() * 2 + 2;
          this.angle = Math.random() * 2 * Math.PI;
          this.vx = 0;
          this.vy = 0;
          this.gravity = 0.05;
          this.fontSize = 16;
        }

        update() {
          this.vx *= 0.98;
          this.vy *= 0.98;
          this.vy += this.gravity;
          this.x += this.vx;
          this.y += this.vy;
          this.alpha -= 0.01;
        }

        draw(ctx) {
          ctx.save();
          ctx.globalAlpha = this.alpha;
          ctx.fillStyle = this.color;
          ctx.font = `bold ${this.fontSize}px 'Consolas', monospace`;
          ctx.fillText(this.char, this.x, this.y);
          ctx.restore();
        }
      }

      function createFirework(x, y) {
        const baseColor = colorSlider.value;
        const phrase = "♥";
        const scale = 4;
        const particles = 100;

        for (let i = 0; i < particles; i++) {
          const t = (i / particles) * 2 * Math.PI;
          const heartX = scale * 16 * Math.pow(Math.sin(t), 3);
          const heartY = -scale * (13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t));

          const p = new Particle(x, y, baseColor, phrase);
          p.vx = heartX * 0.5;
          p.vy = heartY * 0.5;
          fireworks.push(p);
        }
      }

      function drawFireworks() {
        for (let i = fireworks.length - 1; i >= 0; i--) {
          const p = fireworks[i];
          p.update();
          p.draw(ctx);
          if (p.alpha <= 0) {
            fireworks.splice(i, 1);
          }
        }
      }

      let isPaused = false;

      function draw() {
        ctx.fillStyle = "rgba(0, 0, 0, 0.1)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        const baseColor = colorSlider.value;
        ctx.fillStyle = baseColor;
        ctx.font = `bold ${fontSize}px 'Consolas', monospace`;

        for (let i = 0; i < drops.length; i++) {
          ctx.fillText(" Tún iu Hzy ", i * fontSize * densityFactor, drops[i] * fontSize);
          if (!isPaused) {
            if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
              drops[i] = 0;
            }
            drops[i] += speedSlider.value / 100;
          }
        }

        drawFireworks();
      }

      function loop() {
        draw();
        requestAnimationFrame(loop);
      }

      // Bỏ event resize vì canvas đã cố định
      // window.addEventListener('resize', () => {
      //   resizeCanvas();
      //   columns = Math.floor(canvas.width / fontSize / densityFactor);
      //   drops = Array(columns).fill(1);
      // });

      function triggerFireworkAndPause(e) {
        const x = e.clientX || e.touches?.[0].clientX;
        const y = e.clientY || e.touches?.[0].clientY;
        createFirework(x, y);
        isPaused = true;
        setTimeout(() => isPaused = false, 3000);
      }

      window.addEventListener('click', triggerFireworkAndPause);
      window.addEventListener('touchstart', triggerFireworkAndPause);

      loop();
    }
  </script>
</body>
</html>
